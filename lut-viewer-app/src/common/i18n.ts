export type UiLanguage = 'en' | 'zh'

export const DEFAULT_UI_LANGUAGE: UiLanguage = 'en'

const EN_TRANSLATIONS = {
  'common.none': 'None',
  'common.yes': 'Yes',
  'common.no': 'No',
  'common.visible': 'Visible',
  'common.hidden': 'Hidden',

  'shortcut.captureSnapshot': 'Capture Snapshot (P)',
  'shortcut.toggleMute': 'Mute/Unmute (Cmd/Ctrl+Shift+M)',
  'shortcut.filesTab': 'Files Tab (Cmd/Ctrl+1)',
  'shortcut.snapsTab': 'Snaps Tab (Cmd/Ctrl+2)',
  'shortcut.lutsTab': 'LUT Tab (Cmd/Ctrl+3)',
  'shortcut.gradeTab': 'Grade Tab (Cmd/Ctrl+4)',
  'shortcut.toggleSidebar': 'Toggle Sidebar (Cmd/Ctrl+B)',

  'sidebar.tabFiles': 'Files',
  'sidebar.tabSnaps': 'Snaps',
  'sidebar.tabLut': 'LUT',
  'sidebar.tabGrade': 'Grade',
  'sidebar.expandSidebar': 'Expand Sidebar',
  'sidebar.collapseSidebar': 'Collapse',
  'sidebar.clearPlaylistConfirm': 'Clear all files?',
  'sidebar.clearPlaylistTitle': 'Clear Playlist',
  'sidebar.noFilesLoaded': 'No files loaded',
  'sidebar.selectionAll': 'All',
  'sidebar.selectionNone': 'None',
  'sidebar.selectionCurrent': 'Current',
  'sidebar.selectionSummary': '{selected}/{total} selected',
  'sidebar.missingFile': 'MISSING FILE',
  'sidebar.snapshotsCount': 'Snapshots: {count}',
  'sidebar.includeClipInExport': 'Include this clip in video export',
  'sidebar.snapshotTimestamps': 'Snapshot timestamps',
  'sidebar.clear': 'Clear',
  'sidebar.clearSavedTimestampsConfirm': 'Clear all saved timestamps for this video?',
  'sidebar.deleteAllTimestampsTitle': 'Delete all timestamps for this video',
  'sidebar.noSnapshotsForVideo': 'No snapshots yet for this video.',
  'sidebar.timestampEntryTitle': 'Timestamp entry',
  'sidebar.snapFolderLabel': 'Folder: {folder}',
  'sidebar.folderNotSet': 'Not Set',
  'sidebar.setSnapshotFolder': 'Set Snapshot Folder',
  'sidebar.refresh': 'Refresh',
  'sidebar.openFolder': 'Open Folder',
  'sidebar.loadingSnapshots': 'Loading snapshots...',
  'sidebar.noSnapshotsInFolder': 'No snapshots found in folder.',
  'sidebar.noLutFilesFoundAlert': 'No LUT files found. Please drop .cube or .3dl files.',
  'sidebar.addLut': 'Add LUT',
  'sidebar.libraryHint': 'Library (starred stays on top, drag to rank)',
  'sidebar.noLutAddedYet': 'No LUT added yet. Drag .cube/.3dl files here.',
  'sidebar.revealInFinder': 'Right click to reveal in Finder',
  'sidebar.unstarLut': 'Unstar LUT',
  'sidebar.starLut': 'Star LUT',
  'sidebar.removeLut': 'Remove LUT',
  'sidebar.gradeAdjustment': 'Grade Adjustment',
  'sidebar.copy': 'Copy',
  'sidebar.paste': 'Paste',
  'sidebar.reset': 'Reset',
  'sidebar.exposureDistribution': 'Exposure Distribution',
  'sidebar.shadows': 'Shadows',
  'sidebar.midtones': 'Midtones',
  'sidebar.highlights': 'Highlights',
  'sidebar.averageLuma': 'Average Luma',
  'sidebar.blackClip': 'Black Clip',
  'sidebar.whiteClip': 'White Clip',
  'sidebar.zoneRatios': 'Shadows / Midtones / Highlights',
  'sidebar.clipWarningThresholds': 'Clip warning thresholds',
  'sidebar.exposure': 'Exposure',
  'sidebar.contrast': 'Contrast',
  'sidebar.saturation': 'Saturation',
  'sidebar.exportTarget': 'Export target: {target}',
  'sidebar.selectedVideosCount': '{count} selected video{plural}',
  'sidebar.noneSelected': 'none selected',
  'sidebar.importFiles': 'Import Files',
  'sidebar.exportSelectedVideos': 'Export selected videos',
  'sidebar.export': 'Export',
  'sidebar.settings': 'Settings',
  'sidebar.settingsSnapshotFolder': 'Snapshot Folder',
  'sidebar.settingsSnapshotFolderPlaceholder': 'Not set (Ask on first snapshot)',
  'sidebar.settingsShowDebugBars': 'Show Debug Bars',
  'sidebar.settingsPlaybackMode': 'Playback Mode',
  'sidebar.settingsPlaybackOnce': 'Play once and stop (Default)',
  'sidebar.settingsPlaybackSequence': 'Play in list order',
  'sidebar.settingsPlaybackRepeatOne': 'Repeat current video',
  'sidebar.settingsPlaybackShortcutHint': 'Shortcuts: Cmd/Ctrl+E (once), Cmd/Ctrl+O (order), Cmd/Ctrl+R (repeat)',
  'sidebar.settingsTimelineShortcutHint': 'Timeline jump: Cmd/Ctrl+Up (prev timestamp), Cmd/Ctrl+Down (next timestamp)',
  'sidebar.settingsLanguage': 'Language',
  'sidebar.settingsRememberPlaylist': 'Remember Playlist on Restart',
  'sidebar.settingsAutoClear': 'Auto-clear Playlist After Export',
  'sidebar.settingsSmartLut': 'Smart LUT Apply on Export',
  'sidebar.settingsExportQuality': 'Export Quality Profile',
  'sidebar.settingsExportQualitySourceMatch': 'Source Match (best quality)',
  'sidebar.settingsExportQualityBalanced': 'Balanced (smaller file size)',
  'sidebar.settingsResetFolder': 'Reset Folder',
  'sidebar.settingsLutIntensity': 'LUT Intensity: {percent}%',
  'sidebar.designedBy': 'Designed by Vec',
  'sidebar.exportFinished': 'Video export finished.\n{details}',
  'sidebar.exportDetailExported': 'Exported: {count}',
  'sidebar.exportDetailSkippedMissing': 'Skipped missing: {count}',
  'sidebar.exportDetailSkippedUnchanged': 'Skipped unchanged (no LUT/grade): {count}',
  'sidebar.exportDetailFailed': 'Failed: {count}',
  'sidebar.exportDetailRemoved': 'Exported videos removed from playlist.',
  'sidebar.exportUnknownColorSpaceConfirm': 'Color space is unknown for "{name}". Apply current LUT to this clip?',

  'controls.snapshotMarker': 'Snapshot {time}',

  'player.playbackModeRepeatOne': 'Repeat One',
  'player.playbackModeSequence': 'Play in Order',
  'player.playbackModeOnce': 'Play Once & Stop',
  'player.playbackModeNotice': 'Playback Mode: {mode}',
  'player.missingFile': 'Missing file: {name}',
  'player.noVideoSelected': 'No video selected',
  'player.selectSnapshotFolderTitle': 'Select Folder for Snapshots',
  'player.snapshotCanceled': 'Snapshot canceled',
  'player.frameNotReady': 'Frame not ready',
  'player.snapshotSaved': 'Snapshot saved: {filename}',
  'player.failedSaveSnapshotAlert': 'Failed to save snapshot: {error}',
  'player.snapshotCaptureFailedAlert': 'Snapshot capture failed: {error}',
  'player.noSnapshotTimestampsForVideo': 'No snapshot timestamps for this video',
  'player.alreadyAtFirstTimestamp': 'Already at first timestamp',
  'player.alreadyAtLastTimestamp': 'Already at last timestamp',
  'player.jumpedToTimestamp': 'Jumped to {time}',
  'player.gradingReset': 'Grading Reset',
  'player.originalNoLut': 'ORIGINAL (NO LUT)',
  'player.speedNotice': 'Speed: {speed}x',
  'player.debugLut': 'LUT',
  'player.debugReady': 'Ready',
  'player.debugLoaded': 'Loaded',
  'player.debugBypass': 'Bypass',
  'player.debugIntensity': 'Intensity',
  'player.debugCanvas': 'Canvas',
  'player.debugVideo': 'Video',

  'menu.playback': 'Playback',
  'menu.capture': 'Capture',
  'menu.tabs': 'Tabs',
  'menu.view': 'View',
  'menu.shuttleReverse': 'Rewind',
  'menu.shuttleToggle': 'Play/Pause',
  'menu.shuttleForward': 'Forward',
  'menu.playbackModeRepeatOne': 'Repeat One',
  'menu.playbackModeSequence': 'Play in Order',
  'menu.playbackModeOnce': 'Play Once & Stop',
  'menu.toggleLutBypass': 'Enable/Disable LUT',
  'menu.toggleMute': 'Mute/Unmute',
  'menu.captureSnapshot': 'Capture Snapshot',
  'menu.switchToFilesTab': 'Files Tab',
  'menu.switchToSnapsTab': 'Snaps Tab',
  'menu.switchToLutsTab': 'LUT Tab',
  'menu.switchToGradeTab': 'Grade Tab',
  'menu.toggleSidebar': 'Toggle Sidebar',
  'dialog.videos': 'Videos',
  'dialog.luts': 'LUTs'
} as const

type TranslationKey = keyof typeof EN_TRANSLATIONS
type TranslationParams = Record<string, string | number>

const ZH_TRANSLATIONS: Record<TranslationKey, string> = {
  'common.none': '无',
  'common.yes': '是',
  'common.no': '否',
  'common.visible': '可见',
  'common.hidden': '隐藏',

  'shortcut.captureSnapshot': '截图 (P)',
  'shortcut.toggleMute': '静音/取消静音 (Cmd/Ctrl+Shift+M)',
  'shortcut.filesTab': '文件页签 (Cmd/Ctrl+1)',
  'shortcut.snapsTab': '截图页签 (Cmd/Ctrl+2)',
  'shortcut.lutsTab': 'LUT 页签 (Cmd/Ctrl+3)',
  'shortcut.gradeTab': '调色页签 (Cmd/Ctrl+4)',
  'shortcut.toggleSidebar': '切换侧边栏 (Cmd/Ctrl+B)',

  'sidebar.tabFiles': '文件',
  'sidebar.tabSnaps': '截图',
  'sidebar.tabLut': 'LUT',
  'sidebar.tabGrade': '调色',
  'sidebar.expandSidebar': '展开侧边栏',
  'sidebar.collapseSidebar': '收起',
  'sidebar.clearPlaylistConfirm': '清空所有文件？',
  'sidebar.clearPlaylistTitle': '清空播放列表',
  'sidebar.noFilesLoaded': '尚未加载文件',
  'sidebar.selectionAll': '全部',
  'sidebar.selectionNone': '全不选',
  'sidebar.selectionCurrent': '当前',
  'sidebar.selectionSummary': '已选 {selected}/{total}',
  'sidebar.missingFile': '文件丢失',
  'sidebar.snapshotsCount': '截图数: {count}',
  'sidebar.includeClipInExport': '导出时包含这个片段',
  'sidebar.snapshotTimestamps': '截图时间戳',
  'sidebar.clear': '清除',
  'sidebar.clearSavedTimestampsConfirm': '清除该视频所有已保存时间戳？',
  'sidebar.deleteAllTimestampsTitle': '删除该视频所有时间戳',
  'sidebar.noSnapshotsForVideo': '该视频还没有截图。',
  'sidebar.timestampEntryTitle': '时间戳条目',
  'sidebar.snapFolderLabel': '文件夹: {folder}',
  'sidebar.folderNotSet': '未设置',
  'sidebar.setSnapshotFolder': '设置截图文件夹',
  'sidebar.refresh': '刷新',
  'sidebar.openFolder': '打开文件夹',
  'sidebar.loadingSnapshots': '正在加载截图...',
  'sidebar.noSnapshotsInFolder': '该文件夹中没有截图。',
  'sidebar.noLutFilesFoundAlert': '未找到 LUT 文件，请拖入 .cube 或 .3dl 文件。',
  'sidebar.addLut': '添加 LUT',
  'sidebar.libraryHint': '库（收藏保持置顶，可拖动排序）',
  'sidebar.noLutAddedYet': '还没有 LUT，拖入 .cube/.3dl 文件即可。',
  'sidebar.revealInFinder': '右键在 Finder 中显示',
  'sidebar.unstarLut': '取消收藏 LUT',
  'sidebar.starLut': '收藏 LUT',
  'sidebar.removeLut': '移除 LUT',
  'sidebar.gradeAdjustment': '调色调整',
  'sidebar.copy': '复制',
  'sidebar.paste': '粘贴',
  'sidebar.reset': '重置',
  'sidebar.exposureDistribution': '曝光分布图',
  'sidebar.shadows': '阴影',
  'sidebar.midtones': '中间调',
  'sidebar.highlights': '高光',
  'sidebar.averageLuma': '平均亮度',
  'sidebar.blackClip': '黑场截断',
  'sidebar.whiteClip': '高光截断',
  'sidebar.zoneRatios': '阴影 / 中间调 / 高光',
  'sidebar.clipWarningThresholds': '截断预警阈值',
  'sidebar.exposure': '曝光',
  'sidebar.contrast': '对比度',
  'sidebar.saturation': '饱和度',
  'sidebar.exportTarget': '导出目标: {target}',
  'sidebar.selectedVideosCount': '已选 {count} 个视频',
  'sidebar.noneSelected': '未选择',
  'sidebar.importFiles': '导入文件',
  'sidebar.exportSelectedVideos': '导出已选视频',
  'sidebar.export': '导出',
  'sidebar.settings': '设置',
  'sidebar.settingsSnapshotFolder': '截图文件夹',
  'sidebar.settingsSnapshotFolderPlaceholder': '未设置（首次截图时询问）',
  'sidebar.settingsShowDebugBars': '显示调试信息',
  'sidebar.settingsPlaybackMode': '播放模式',
  'sidebar.settingsPlaybackOnce': '播放一次后停止（默认）',
  'sidebar.settingsPlaybackSequence': '按列表顺序播放',
  'sidebar.settingsPlaybackRepeatOne': '循环当前视频',
  'sidebar.settingsPlaybackShortcutHint': '快捷键：Cmd/Ctrl+E（单次），Cmd/Ctrl+O（顺序），Cmd/Ctrl+R（循环）',
  'sidebar.settingsTimelineShortcutHint': '时间轴跳转：Cmd/Ctrl+上（上个时间戳），Cmd/Ctrl+下（下个时间戳）',
  'sidebar.settingsLanguage': '语言',
  'sidebar.settingsRememberPlaylist': '重启后记住播放列表',
  'sidebar.settingsAutoClear': '导出后自动清空播放列表',
  'sidebar.settingsSmartLut': '导出时智能应用 LUT',
  'sidebar.settingsExportQuality': '导出质量策略',
  'sidebar.settingsExportQualitySourceMatch': '匹配源素材（最佳质量）',
  'sidebar.settingsExportQualityBalanced': '平衡（更小文件体积）',
  'sidebar.settingsResetFolder': '重置文件夹',
  'sidebar.settingsLutIntensity': 'LUT 强度: {percent}%',
  'sidebar.designedBy': '由 Vec 设计',
  'sidebar.exportFinished': '视频导出完成。\n{details}',
  'sidebar.exportDetailExported': '已导出: {count}',
  'sidebar.exportDetailSkippedMissing': '已跳过缺失文件: {count}',
  'sidebar.exportDetailSkippedUnchanged': '已跳过未改动（无 LUT/调色）: {count}',
  'sidebar.exportDetailFailed': '失败: {count}',
  'sidebar.exportDetailRemoved': '已从播放列表移除导出成功的视频。',
  'sidebar.exportUnknownColorSpaceConfirm': '“{name}” 的色彩空间未知。是否对该片段应用当前 LUT？',

  'controls.snapshotMarker': '截图 {time}',

  'player.playbackModeRepeatOne': '单片循环',
  'player.playbackModeSequence': '顺序播放',
  'player.playbackModeOnce': '播放一次并停止',
  'player.playbackModeNotice': '播放模式: {mode}',
  'player.missingFile': '文件丢失: {name}',
  'player.noVideoSelected': '未选择视频',
  'player.selectSnapshotFolderTitle': '选择截图文件夹',
  'player.snapshotCanceled': '已取消截图',
  'player.frameNotReady': '帧尚未就绪',
  'player.snapshotSaved': '截图已保存: {filename}',
  'player.failedSaveSnapshotAlert': '保存截图失败: {error}',
  'player.snapshotCaptureFailedAlert': '截图失败: {error}',
  'player.noSnapshotTimestampsForVideo': '该视频没有截图时间戳',
  'player.alreadyAtFirstTimestamp': '已经在第一个时间戳',
  'player.alreadyAtLastTimestamp': '已经在最后一个时间戳',
  'player.jumpedToTimestamp': '已跳转到 {time}',
  'player.gradingReset': '调色已重置',
  'player.originalNoLut': '原片（未应用 LUT）',
  'player.speedNotice': '速度: {speed}x',
  'player.debugLut': 'LUT',
  'player.debugReady': '就绪',
  'player.debugLoaded': '已加载',
  'player.debugBypass': '绕过',
  'player.debugIntensity': '强度',
  'player.debugCanvas': '画布',
  'player.debugVideo': '视频',

  'menu.playback': '播放',
  'menu.capture': '截图',
  'menu.tabs': '页签',
  'menu.view': '视图',
  'menu.shuttleReverse': '倒放',
  'menu.shuttleToggle': '播放/暂停',
  'menu.shuttleForward': '快进',
  'menu.playbackModeRepeatOne': '单片循环',
  'menu.playbackModeSequence': '顺序播放',
  'menu.playbackModeOnce': '播放一次并停止',
  'menu.toggleLutBypass': '启用/禁用 LUT',
  'menu.toggleMute': '静音/取消静音',
  'menu.captureSnapshot': '截图',
  'menu.switchToFilesTab': '文件页签',
  'menu.switchToSnapsTab': '截图页签',
  'menu.switchToLutsTab': 'LUT 页签',
  'menu.switchToGradeTab': '调色页签',
  'menu.toggleSidebar': '切换侧边栏',
  'dialog.videos': '视频',
  'dialog.luts': 'LUT 文件'
}

const TRANSLATIONS: Record<UiLanguage, Record<TranslationKey, string>> = {
  en: EN_TRANSLATIONS,
  zh: ZH_TRANSLATIONS
}

const interpolate = (template: string, params?: TranslationParams): string => {
  if (!params) return template
  return template.replace(/\{([a-zA-Z0-9_]+)\}/g, (_, key: string) => {
    const value = params[key]
    return value == null ? `{${key}}` : String(value)
  })
}

export const normalizeUiLanguage = (value: unknown): UiLanguage => {
  return value === 'zh' ? 'zh' : DEFAULT_UI_LANGUAGE
}

export const translate = (
  language: UiLanguage,
  key: TranslationKey,
  params?: TranslationParams
): string => {
  const table = TRANSLATIONS[normalizeUiLanguage(language)]
  const fallback = TRANSLATIONS[DEFAULT_UI_LANGUAGE][key]
  return interpolate(table[key] ?? fallback, params)
}

export const createTranslator = (language: UiLanguage | string) => {
  const normalized = normalizeUiLanguage(language)
  return (key: TranslationKey, params?: TranslationParams): string => translate(normalized, key, params)
}

export type { TranslationKey, TranslationParams }
